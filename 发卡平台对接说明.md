# 发卡平台对接说明

本系统支持对接多个主流发卡平台，包括易支付、独角数卡、鲸发卡等。

## 支持的平台

### 1. 易支付（推荐）
- **平台代码**: `epay`
- **特点**: 接口简单，稳定可靠
- **支持支付方式**: 支付宝、微信、QQ钱包
- **官网**: 搜索"易支付"找到服务商

### 2. 独角数卡
- **平台代码**: `dujiao`
- **特点**: 专业发卡平台，功能强大
- **支持支付方式**: 支付宝、微信
- **官网**: https://www.dujiaoka.com/

### 3. 鲸发卡
- **平台代码**: `jingfaka`
- **特点**: 新兴平台，费率优惠
- **支持支付方式**: 支付宝、微信
- **官网**: 搜索"鲸发卡"

## 配置方法

### 步骤一：选择平台

编辑 `.env` 文件，设置 `CARD_PLATFORM` 参数：

```env
# 选择发卡平台：epay(易支付), dujiao(独角数卡), jingfaka(鲸发卡)
CARD_PLATFORM=epay
```

### 步骤二：配置对应平台参数

#### 易支付配置

```env
CARD_PLATFORM=epay

# 易支付配置
EPAY_API_URL=https://pay.example.com
EPAY_PID=10001
EPAY_KEY=your_epay_key_here
```

**获取方式：**
1. 注册易支付账号
2. 实名认证
3. 在商户后台获取 PID 和 KEY
4. 记录 API 地址

#### 独角数卡配置

```env
CARD_PLATFORM=dujiao

# 独角数卡配置
DUJIAO_API_URL=https://api.dujiaoka.com
DUJIAO_API_KEY=your_dujiao_api_key_here
```

**获取方式：**
1. 注册独角数卡账号
2. 在后台"API设置"中获取 API KEY
3. 记录 API 地址

#### 鲸发卡配置

```env
CARD_PLATFORM=jingfaka

# 鲸发卡配置
JINGFAKA_API_URL=https://api.jingfaka.com
JINGFAKA_API_KEY=your_jingfaka_api_key_here
```

**获取方式：**
1. 注册鲸发卡账号
2. 在后台"开发者设置"中获取 API KEY
3. 记录 API 地址

### 步骤三：重启服务

```bash
docker-compose restart app
```

## 支付方式对照表

| 平台 | 支付宝 | 微信 | QQ钱包 |
|------|--------|------|--------|
| 易支付 | alipay | wxpay | qqpay |
| 独角数卡 | alipay | wxpay | ❌ |
| 鲸发卡 | alipay | wechat | ❌ |

## 回调地址配置

在发卡平台后台配置回调地址：

```
异步通知地址: https://your-domain.com/api/payment/notify
同步返回地址: https://your-domain.com/order/success
```

⚠️ **注意**: 必须使用 HTTPS，否则回调可能失败！

## 测试支付

### 1. 创建测试订单

1. 访问网站前台
2. 注册账号并登录
3. 选择商品购买
4. 填写联系邮箱
5. 点击"立即购买"

### 2. 选择支付方式

根据平台支持的支付方式选择：
- 支付宝
- 微信支付

### 3. 完成支付

- 使用测试金额（如 0.01 元）
- 扫码或跳转支付
- 支付成功后自动跳转

### 4. 查看订单

- 在订单查询页面输入订单号
- 查看卡密信息
- 卡密会发送到邮箱（如果配置了邮件）

## 常见问题

### Q1: 支付后没有回调？

**检查步骤：**

1. 确认回调地址配置正确
2. 确认服务器可以被外网访问
3. 查看应用日志：
```bash
docker-compose logs app | grep payment
```

4. 检查防火墙是否拦截

### Q2: 签名验证失败？

**解决方法：**

1. 检查 API KEY 是否正确
2. 检查时间是否同步：
```bash
date
ntpdate ntp.aliyun.com
```

3. 查看详细错误日志

### Q3: 如何切换平台？

```bash
# 1. 编辑配置
nano .env

# 2. 修改 CARD_PLATFORM
CARD_PLATFORM=dujiao

# 3. 配置新平台的参数

# 4. 重启服务
docker-compose restart app
```

### Q4: 可以同时使用多个平台吗？

目前不支持同时使用多个平台，但可以通过修改代码实现：

1. 在订单表添加 `platform` 字段
2. 创建订单时选择平台
3. 支付时根据订单的平台调用对应接口

## 平台对比

| 特性 | 易支付 | 独角数卡 | 鲸发卡 |
|------|--------|----------|--------|
| 接入难度 | ⭐⭐ | ⭐⭐⭐ | ⭐⭐ |
| 稳定性 | ⭐⭐⭐⭐ | ⭐⭐⭐⭐⭐ | ⭐⭐⭐ |
| 费率 | 中等 | 较低 | 较低 |
| 功能 | 基础 | 丰富 | 基础 |
| 文档 | 一般 | 详细 | 一般 |

## 推荐配置

### 新手推荐：易支付
- 接入简单
- 文档清晰
- 社区活跃

### 专业用户：独角数卡
- 功能强大
- 稳定可靠
- 支持多种支付方式

### 成本敏感：鲸发卡
- 费率较低
- 接口简单
- 适合小规模使用

## 技术支持

如有问题，请：
1. 查看平台官方文档
2. 查看系统日志
3. 提交 Issue

---

**注意**: 使用任何支付接口前，请确保已完成实名认证和资质审核。
